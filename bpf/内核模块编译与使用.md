### 1. make
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# make
make -C /lib/modules/6.8.0-63-generic/build M=/home/jeff/share/bpf/bpftrace/module modules
make[1]: Entering directory '/usr/src/linux-headers-6.8.0-63-generic'
warning: the compiler differs from the one used to build the kernel
  The kernel was built by: x86_64-linux-gnu-gcc-13 (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0
  You are using:           gcc-13 (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0
  CC [M]  /home/jeff/share/bpf/bpftrace/module/kernel_module.o
  MODPOST /home/jeff/share/bpf/bpftrace/module/Module.symvers
  CC [M]  /home/jeff/share/bpf/bpftrace/module/kernel_module.mod.o
  LD [M]  /home/jeff/share/bpf/bpftrace/module/kernel_module.ko
  BTF [M] /home/jeff/share/bpf/bpftrace/module/kernel_module.ko
Skipping BTF generation for /home/jeff/share/bpf/bpftrace/module/kernel_module.ko due to unavailability of vmlinux
make[1]: Leaving directory '/usr/src/linux-headers-6.8.0-63-generic'
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# ls
kernel_module.c  kernel_module.ko  kernel_module.mod  kernel_module.mod.c  kernel_module.mod.o  kernel_module.o  Makefile  modules.order  Module.symvers
```

### 2. insmod
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# insmod kernel_module.ko
```
### 3. dmesg
dmesg æ˜¯ Linux ç³»ç»Ÿä¸­ç”¨äºæŸ¥çœ‹å†…æ ¸æ—¥å¿—ä¿¡æ¯çš„å‘½ä»¤ã€‚å®ƒå¯ä»¥æ˜¾ç¤ºå†…æ ¸å¯åŠ¨ä¿¡æ¯ã€é©±åŠ¨åŠ è½½ã€æ¨¡å—æ’å…¥ã€ç³»ç»Ÿè°ƒç”¨é”™è¯¯ã€ç¡¬ä»¶å¼‚å¸¸ç­‰å†…å®¹
```
[ 1577.236290] kernel_module: loading out-of-tree module taints kernel.
[ 1577.236308] kernel_module: module verification failed: signature and/or required key missing - tainting kernel
[ 1577.236891] Kernal Module Initialized
```
- ğŸ”¸ è¿™æ˜¯ä¸€ä¸ªéå†…æ ¸è‡ªå¸¦æ¨¡å—ï¼ˆout-of-treeï¼‰ï¼Œæ¯”å¦‚ä½ è‡ªå·±ç¼–è¯‘çš„æ¨¡å—ã€‚
- ğŸ”¸ å†…æ ¸ä¸ºäº†ç¨³å®šæ€§ä¼šæ ‡è®°è¿™ç±»æ¨¡å—ä¸ºâ€œæ±¡æŸ“ï¼ˆtaintedï¼‰â€ï¼Œä½†ä¸å½±å“ä½¿ç”¨ï¼›
- âœ… å®‰å…¨å¯ä»¥æ¥å—ï¼Œä¸å½±å“ä½ å¼€å‘æµ‹è¯•ã€‚


- ğŸ”¸ æ¨¡å— æœªç­¾åï¼Œè€Œå½“å‰å†…æ ¸å¯ç”¨äº† æ¨¡å—ç­¾åæ ¡éªŒï¼ˆmodule signature verificationï¼‰ï¼›
- âœ… ä¸å½±å“æ¨¡å—è¿è¡Œï¼Œåªæ˜¯å†æ¬¡â€œtaintâ€æ ‡è®°ï¼›
- âš ï¸ è‹¥ä½ éœ€è¦åœ¨å¯ç”¨äº† UEFI Secure Boot çš„ç¯å¢ƒä¸­åŠ è½½ï¼Œéœ€å…³é—­ Secure Boot æˆ–å¯¹æ¨¡å—ç­¾åï¼›

```
root@worker02:/home/jeff/share/bpf/bpftrace/module# rmmod kernel_module.ko
```
```
[ 2397.825430] Kernal Module Exited
```
### 4.ç”¨æˆ·ç©ºé—´ä¼ å…¥å‚æ•°ä¿¡æ¯
> ä¿®æ”¹kernel_module.c
```
#include <linux/module.h>
#include <linux/kernel.h>

pid_t pid = 0; // Global variable to hold the PID
module_param(pid, int, S_IRUGO); // Module parameter to set PID from user space

// insmod kernal_module.ko
static int kernal_module_init(void) {
    printk(KERN_INFO "Kernal Module Initialized: %d\n", pid);
    return 0; // Return 0 on success
}

// rmmod kernal_module
static void kernal_module_exit(void) {
    printk(KERN_INFO "Kernal Module Exited\n");
}

module_init(kernal_module_init);
module_exit(kernal_module_exit);
MODULE_LICENSE("GPL");
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# insmod kernel_module.ko pid=1234
```
```
root@worker02:/home/jeff/share/bpf/bpftrace# dmesg -C
root@worker02:/home/jeff/share/bpf/bpftrace# dmesg
[ 3660.211624] Kernal Module Initialized: 1234
```
### 5.æ ¹æ®ä¼ å…¥çš„ PID æŸ¥æ‰¾å¯¹åº”è¿›ç¨‹ï¼Œå¹¶æ‰“å°è¯¥è¿›ç¨‹çš„åç§°ï¼ˆcommï¼‰åˆ°å†…æ ¸æ—¥å¿—
```
#include <linux/module.h>
#include <linux/kernel.h>

pid_t pid = 0; // Global variable to hold the PID

module_param(pid, int, S_IRUGO); // Module parameter to set PID from user space

// insmod kernal_module.ko
static int kernal_module_init(void) {

    
    struct pid *spid;
    struct task_struct *task;
    printk(KERN_INFO "Kernal Module Initialized: %d\n", pid);
    if (pid <= 0) {
        return -1; // Return error if PID is invalid
    }

    spid = find_get_pid(pid);
    task = get_pid_task(spid, PIDTYPE_PID);
    if (!task) {
        return -1; // Return error if task is not found
    }
    printk("name: %s\n", task->comm);

    return 0; // Return 0 on success
} 
// rmmod kernal_module
static void kernal_module_exit(void) {
    printk(KERN_INFO "Kernal Module Exited\n");
}

module_init(kernal_module_init);
module_exit(kernal_module_exit);

MODULE_LICENSE("GPL");
```

```
root@worker02:/home/jeff# ps -aux | grep mysql
mysql      33119  1.0 10.0 2443932 397136 ?      Ssl  15:57   0:01 /usr/sbin/mysqld
root       33770  0.0  0.1  17144  7168 pts/3    S+   15:59   0:00 sudo mysql -u root -p
root       33771  0.0  0.0  17144  2500 pts/0    Ss   15:59   0:00 sudo mysql -u root -p
root       33772  0.0  0.2  23888 10624 pts/0    S+   15:59   0:00 mysql -u root -p
root       34332  0.0  0.0   6544  2304 pts/6    S+   16:00   0:00 grep --color=auto mysql
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# insmod kernel_module.ko pid=33119
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# dmesg
[ 4824.120606] Kernal Module Initialized: 33119
[ 4824.120612] name: mysqld
```
