### 1. make
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# make
make -C /lib/modules/6.8.0-63-generic/build M=/home/jeff/share/bpf/bpftrace/module modules
make[1]: Entering directory '/usr/src/linux-headers-6.8.0-63-generic'
warning: the compiler differs from the one used to build the kernel
  The kernel was built by: x86_64-linux-gnu-gcc-13 (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0
  You are using:           gcc-13 (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0
  CC [M]  /home/jeff/share/bpf/bpftrace/module/kernel_module.o
  MODPOST /home/jeff/share/bpf/bpftrace/module/Module.symvers
  CC [M]  /home/jeff/share/bpf/bpftrace/module/kernel_module.mod.o
  LD [M]  /home/jeff/share/bpf/bpftrace/module/kernel_module.ko
  BTF [M] /home/jeff/share/bpf/bpftrace/module/kernel_module.ko
Skipping BTF generation for /home/jeff/share/bpf/bpftrace/module/kernel_module.ko due to unavailability of vmlinux
make[1]: Leaving directory '/usr/src/linux-headers-6.8.0-63-generic'
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# ls
kernel_module.c  kernel_module.ko  kernel_module.mod  kernel_module.mod.c  kernel_module.mod.o  kernel_module.o  Makefile  modules.order  Module.symvers
```

### 2. insmod
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# insmod kernel_module.ko
```
### 3. dmesg
dmesg 是 Linux 系统中用于查看内核日志信息的命令。它可以显示内核启动信息、驱动加载、模块插入、系统调用错误、硬件异常等内容
```
[ 1577.236290] kernel_module: loading out-of-tree module taints kernel.
[ 1577.236308] kernel_module: module verification failed: signature and/or required key missing - tainting kernel
[ 1577.236891] Kernal Module Initialized
```
- 🔸 这是一个非内核自带模块（out-of-tree），比如你自己编译的模块。
- 🔸 内核为了稳定性会标记这类模块为“污染（tainted）”，但不影响使用；
- ✅ 安全可以接受，不影响你开发测试。


- 🔸 模块 未签名，而当前内核启用了 模块签名校验（module signature verification）；
- ✅ 不影响模块运行，只是再次“taint”标记；
- ⚠️ 若你需要在启用了 UEFI Secure Boot 的环境中加载，需关闭 Secure Boot 或对模块签名；

```
root@worker02:/home/jeff/share/bpf/bpftrace/module# rmmod kernel_module.ko
```
```
[ 2397.825430] Kernal Module Exited
```
### 4.用户空间传入参数信息
> 修改kernel_module.c
```
#include <linux/module.h>
#include <linux/kernel.h>

pid_t pid = 0; // Global variable to hold the PID
module_param(pid, int, S_IRUGO); // Module parameter to set PID from user space

// insmod kernal_module.ko
static int kernal_module_init(void) {
    printk(KERN_INFO "Kernal Module Initialized: %d\n", pid);
    return 0; // Return 0 on success
}

// rmmod kernal_module
static void kernal_module_exit(void) {
    printk(KERN_INFO "Kernal Module Exited\n");
}

module_init(kernal_module_init);
module_exit(kernal_module_exit);
MODULE_LICENSE("GPL");
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# insmod kernel_module.ko pid=1234
```
```
root@worker02:/home/jeff/share/bpf/bpftrace# dmesg -C
root@worker02:/home/jeff/share/bpf/bpftrace# dmesg
[ 3660.211624] Kernal Module Initialized: 1234
```
### 5.根据传入的 PID 查找对应进程，并打印该进程的名称（comm）到内核日志
```
#include <linux/module.h>
#include <linux/kernel.h>

pid_t pid = 0; // Global variable to hold the PID

module_param(pid, int, S_IRUGO); // Module parameter to set PID from user space

// insmod kernal_module.ko
static int kernal_module_init(void) {

    
    struct pid *spid;
    struct task_struct *task;
    printk(KERN_INFO "Kernal Module Initialized: %d\n", pid);
    if (pid <= 0) {
        return -1; // Return error if PID is invalid
    }

    spid = find_get_pid(pid);
    task = get_pid_task(spid, PIDTYPE_PID);
    if (!task) {
        return -1; // Return error if task is not found
    }
    printk("name: %s\n", task->comm);

    return 0; // Return 0 on success
} 
// rmmod kernal_module
static void kernal_module_exit(void) {
    printk(KERN_INFO "Kernal Module Exited\n");
}

module_init(kernal_module_init);
module_exit(kernal_module_exit);

MODULE_LICENSE("GPL");
```

```
root@worker02:/home/jeff# ps -aux | grep mysql
mysql      33119  1.0 10.0 2443932 397136 ?      Ssl  15:57   0:01 /usr/sbin/mysqld
root       33770  0.0  0.1  17144  7168 pts/3    S+   15:59   0:00 sudo mysql -u root -p
root       33771  0.0  0.0  17144  2500 pts/0    Ss   15:59   0:00 sudo mysql -u root -p
root       33772  0.0  0.2  23888 10624 pts/0    S+   15:59   0:00 mysql -u root -p
root       34332  0.0  0.0   6544  2304 pts/6    S+   16:00   0:00 grep --color=auto mysql
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# insmod kernel_module.ko pid=33119
```
```
root@worker02:/home/jeff/share/bpf/bpftrace/module# dmesg
[ 4824.120606] Kernal Module Initialized: 33119
[ 4824.120612] name: mysqld
```
